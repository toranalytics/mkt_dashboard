<!DOCTYPE html>
<html>
<head>
    <title>Facebook 광고 성과</title>
    <style>
        body { font-family: sans-serif; }
        .date-input-container { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; }
        input[type="date"] { padding: 8px; }
        button { padding: 10px 20px; cursor: pointer; }
        #report-container { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .total-row { background-color: #e6f2ff; font-weight: bold; }
        .high-performance { color: #ff9900; font-weight: bold; }
        .winning-content { color: #009900; font-weight: bold; }
        img { max-width: 100px; max-height: 100px; }
    </style>
</head>
<body>
    <h1>Facebook 광고 성과 보고서</h1>
    <div class="date-input-container">
        <label for="start_date">시작 날짜:</label>
        <input type="date" id="start_date" name="start_date">
    </div>
    <div class="date-input-container">
        <label for="end_date">종료 날짜:</label>
        <input type="date" id="end_date" name="end_date">
    </div>
    <button onclick="fetchReport()">보고서 생성</button>
    <div id="report-container">
        </div>

    <script>
        async function fetchReport() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            if (!startDate || !endDate) {
                alert('시작 날짜와 종료 날짜를 모두 선택해주세요.');
                return;
            }

            const response = await fetch('/.netlify/functions/get_facebook_ads_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ start_date: startDate, end_date: endDate }),
            });

            if (response.ok) {
                const data = await response.json();
                displayReport(data);
            } else {
                const error = await response.text();
                document.getElementById('report-container').innerHTML = `<p>오류 발생: ${error}</p>`;
            }
        }

        function displayReport(data) {
            const reportContainer = document.getElementById('report-container');
            if (!data || data.length === 0) {
                reportContainer.innerHTML = '<p>해당 기간의 데이터가 없습니다.</p>';
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>광고명</th>
                            <th>캠페인명</th>
                            <th>광고세트명</th>
                            <th>FB 광고비용</th>
                            <th>노출</th>
                            <th>Click</th>
                            <th>CTR</th>
                            <th>CPC</th>
                            <th>광고 성과</th>
                            <th>광고 이미지</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let totals = { 'FB 광고비용': 0, '노출': 0, 'Click': 0 };
            let totalClicks = 0;
            let totalImpressions = 0;

            data.forEach(row => {
                const isTotalRow = row.광고명 === '합계';
                const rowClass = isTotalRow ? 'total-row' : '';
                const performanceClass = row['광고 성과'] === '고성과' ? 'high-performance' : (row['광고 성과'] === '위닝콘텐츠' ? 'winning-content' : '');
                const imgTag = row.image_url ? `<img src="${row.image_url}">` : '';

                if (!isTotalRow) {
                    totals['FB 광고비용'] += parseFloat(row['FB 광고비용'] || 0);
                    totals['노출'] += parseInt(row['노출'] || 0);
                    totals['Click'] += parseInt(row['Click'] || 0);
                }

                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${row.광고명 || ''}</td>
                        <td>${row.캠페인명 || ''}</td>
                        <td>${row.광고세트명 || ''}</td>
                        <td>${parseFloat(row['FB 광고비용'] || 0).toFixed(2)}</td>
                        <td>${parseInt(row['노출'] || 0).toLocaleString()}</td>
                        <td>${parseInt(row['Click'] || 0).toLocaleString()}</td>
                        <td>${row.CTR || ''}</td>
                        <td>${parseFloat(row.CPC || 0).toFixed(2)}</td>
                        <td class="${performanceClass}">${row['광고 성과'] || ''}</td>
                        <td>${imgTag}</td>
                    </tr>
                `;
            });

            const avgCtr = totals['노출'] > 0 ? ((totals['Click'] / totals['노출']) * 100).toFixed(2) + '%' : '0%';
            tableHTML += `
                    <tr class="total-row">
                        <td>합계</td>
                        <td></td>
                        <td></td>
                        <td>${totals['FB 광고비용'].toFixed(2)}</td>
                        <td>${totals['노출'].toLocaleString()}</td>
                        <td>${totals['Click'].toLocaleString()}</td>
                        <td>${avgCtr}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            `;
            reportContainer.innerHTML = tableHTML;
        }

        // 현재 날짜로 input 필드 초기화 (선택 사항)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('start_date').value = today;
        document.getElementById('end_date').value = today;
    </script>
</body>
</html>
